&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	НазначениеПлатежа 	= Параметры.НазначениеПлатежа;
	СчетПолучателя 		= Параметры.СчетПолучателя;
	
	Если ПустаяСтрока(НазначениеПлатежа) Тогда
		НачальноеЗаполнение();
	Иначе		
		РазобратьНазначение();
		ПроверитьЗаполнениеОбязательныхПолей();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура СообщениеОбОшибкеФорматаПлатежа(НомерПоля, СодержаниеОшибки, Ошибка)
	
	Ошибка = Истина;
	
	ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Поле %1: неверный формат: %2';uk= 'Поле %1: невірний формат: %2'"),
			                                                            НомерПоля,
			                                                            СодержаниеОшибки);
	
	ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);

КонецПроцедуры

&НаСервере
Функция ПроверитьЗаполнениеОбязательныхПолей()

	Ошибка = Ложь;
	
	// ПОЛЕ 1
	Если Поле1 <> "*" Тогда
		
		СообщениеОбОшибкеФорматаПлатежа(1, НСтр("ru='ожидается  "" * ""';uk='очікується "" * ""'"), Ошибка)		
		
	КонецЕсли;		
	
	// ПОЛЕ 2
	Если Лев(Поле2,1) <> ";" Тогда
		         
		СообщениеОбОшибкеФорматаПлатежа(2, НСтр("ru='поле должно начинаться со знака "" ; ""';uk='поле повинно починатися зі знака "" ; ""'"), Ошибка)		
		
	Иначе
		
		Код = Сред(Поле2, 2);
		
		Попытка
		
			Код = Число(Код);
			Если Код < 101 Тогда
			
				СообщениеОбОшибкеФорматаПлатежа(2, НСтр("ru='неверный код платежа';uk='невірний код платежу'"), Ошибка)		
			
			КонецЕсли;
		
		Исключение
			
			СообщениеОбОшибкеФорматаПлатежа(2, НСтр("ru='неверный код платежа';uk='невірний код платежу'"), Ошибка)		
			
		КонецПопытки; 
		
		
	КонецЕсли;		
	
	// ПОЛЕ 3
	Если Лев(Поле3,1) <> ";" Тогда
		         
		СообщениеОбОшибкеФорматаПлатежа(3, НСтр("ru='поле должно начинаться со знака "" ; ""';uk='поле повинно починатися зі знака "" ; ""'"), Ошибка)		
		
	Иначе 
		
		Код = Сред(Поле3, 2);
		Попытка
		
			Код = Число(Код);
			Если Код > 0 И Код < 100000000 Тогда
				
				// КОД ЕДРПОУ должен быть с ведущими нулями до 8 символов
				Если СтрДлина(Сред(Поле3, 2)) < 8 Тогда
				
					СообщениеОбОшибкеФорматаПлатежа(3, НСтр("ru='неверный код контрагента';uk='невірний код контрагента'"), Ошибка)			
				
				КонецЕсли; 
			
			КонецЕсли;
		
		Исключение
			
			СообщениеОбОшибкеФорматаПлатежа(3, НСтр("ru='неверный код контрагента';uk='невірний код контрагента'"), Ошибка)		
			
		КонецПопытки; 
		
	КонецЕсли;		
	
	// ПОЛЕ 4
	Если Лев(Поле4,1) <> ";" Тогда
		         
		СообщениеОбОшибкеФорматаПлатежа(4, НСтр("ru='поле должно начинаться со знака "" ; ""';uk='поле повинно починатися зі знака "" ; ""'"), Ошибка)		
		
	КонецЕсли;			
	
	// ПОЛЕ 5
	Если Лев(Поле5,1) <> ";" Тогда
		         
		СообщениеОбОшибкеФорматаПлатежа(5, НСтр("ru='поле должно начинаться со знака "" ; ""';uk='поле повинно починатися зі знака "" ; ""'"), Ошибка)		
		
	КонецЕсли;			
	
	// ПОЛЕ 6
	Если Не ПустаяСтрока(Поле6) И Лев(Поле6,1) <> ";" Тогда
		         
		СообщениеОбОшибкеФорматаПлатежа(6, НСтр("ru='поле должно начинаться со знака "" ; ""';uk='поле повинно починатися зі знака "" ; ""'"), Ошибка)		
		
	КонецЕсли;			
	
	// ПОЛЕ 7
	Если Не ПустаяСтрока(Поле7) И Лев(Поле7,1) <> ";" Тогда
		         
		СообщениеОбОшибкеФорматаПлатежа(7, НСтр("ru='поле должно начинаться со знака "" ; ""';uk='поле повинно починатися зі знака "" ; ""'"), Ошибка)		
		
	КонецЕсли;			
	
	Возврат Ошибка;
	
КонецФункции

&НаСервере
Процедура НачальноеЗаполнение()

	Поле1 = "*";
	Поле2 = ";101";
	Поле3 = "; ";
	
	Поле4 = "; ";
	
	//Если Поле4 до этого не заполнено, и если заполнен "Банковский счет получателя",записывает "текст назначения" из него в Поле4
	Если Поле4 = "; " И Не СчетПолучателя.Пустая() Тогда
		Поле4 = Поле4 + СчетПолучателя.ТекстНазначения;
	КонецЕсли;
	
	Поле5 = ";";
	Поле6 = "";
	Поле7 = "";
	
	ОбновитьНазначениеПлатежа();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьНазначениеПлатежа()
	
	НазначениеПлатежа = Поле1 + Поле2 + Поле3 + Поле4 + Поле5 + Поле6 + Поле7;
	
КонецПроцедуры	

&НаСервере
Процедура РазобратьНазначение()

	НазначениеПлатежа = СокрЛ(НазначениеПлатежа);
	
	Копия = НазначениеПлатежа;
	
	Если Найти(Копия, Символы.ПС) > 0  Тогда
	
		Копия = СтрЗаменить(Копия, Символы.ПС, " "); 
		
	Иначе
		
		Копия = СтрЗаменить(Копия, ";", Символы.ПС + ";");
		 
	КонецЕсли;
	
	Для Инд = 1 По СтрЧислоСтрок(Копия) Цикл
		
		Поле = СтрПолучитьСтроку(Копия, Инд);
		
		Если Инд > 7 Тогда
			Продолжить;
		КонецЕсли;
		
		// инд лежит в диапазоне 1...7
		ЭтаФорма["Поле"+Инд] = Поле;
		
	КонецЦикла;
	
	ОбновитьНазначениеПлатежа();
	
КонецПроцедуры

&НаКлиенте
Процедура ПолеПриИзменении(Элемент)
	ОбновитьНазначениеПлатежа()
КонецПроцедуры

&НаКлиенте
Процедура ОК(Команда)
	
	Если ПроверитьЗаполнениеОбязательныхПолей() Тогда
	    // есть ошибки
		Если Вопрос(НСтр("ru='Закончить редактирование?';uk='Закінчити редагування?'"), РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			
			Возврат;	
			
		КонецЕсли;
		
	КонецЕсли;
	
	Закрыть(КодВозвратаДиалога.OK);
	
	Структура = Новый Структура("НазначениеПлатежа", НазначениеПлатежа);
	ОповеститьОВыборе(Структура);
	
КонецПроцедуры

&НаКлиенте
Процедура ПоУмолчанию(Команда)
	НачальноеЗаполнение();
КонецПроцедуры
