
Процедура СформироватьОтчет(ТабДокумент) Экспорт
	
	НачалоПериода = ПериодОтчета.ДатаНачала;
	КонецПериода = ПериодОтчета.ДатаОкончания;
	
	Макет = ПолучитьМакет("UK_Макет2023");
	
	ТабДокумент.Очистить();
	ОбластьМакета = Макет.ПолучитьОбласть("Шапка");
	СведенияОбОрганизации = БухгалтерскийУчетПереопределяемый.СведенияОЮрФизЛице(Организация, КонецПериода);
	ОбластьМакета.Параметры.НазваниеОрганизации = СведенияОбОрганизации.ПолноеНаименование;
	ОбластьМакета.Параметры.НалоговыйНомер = БухгалтерскийУчетПереопределяемый.ПолучитьКодОрганизации(СведенияОбОрганизации);
	ТабДокумент.Вывести(ОбластьМакета);
	ОбластьМакета = Макет.ПолучитьОбласть("ЗаголовокТаблицыДоходы");
	ТабДокумент.Вывести(ОбластьМакета);
	
	ОтчетКнигаДоходов = Отчеты.КнигаДоходовПоЕдиномуНалогу.Создать();
	ЗаполнитьЗначенияСвойств(ОтчетКнигаДоходов, ЭтотОбъект);  
	ОтчетКнигаДоходов.СформироватьОтчет(ТабДокумент, Ложь, Ложь);
	
	ОбластьМакета = Макет.ПолучитьОбласть("ЗаголовокТаблицыРасходы");
	ТабДокумент.Вывести(ОбластьМакета);
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода", КонецДня(КонецПериода));
	Запрос.УстановитьПараметр("Организация", Организация);
	
	Запрос.УстановитьПараметр("СтатьяЗатратыСвязанныеСПриобретением", Справочники.СтатьиНалоговыхДеклараций.ЕННК_ЗатратыЗатратыСвязанныеСПриобретением);
	Запрос.УстановитьПараметр("СтатьяОплатаТруда",                    Справочники.СтатьиНалоговыхДеклараций.ЕННК_ЗатратыОплатаТруда);
	Запрос.УстановитьПараметр("СтатьяЕСВ",                            Справочники.СтатьиНалоговыхДеклараций.ЕННК_ЗатратыЕСВ);
	Запрос.УстановитьПараметр("СтатьяДругиеЗатраты",                  Справочники.СтатьиНалоговыхДеклараций.ЕННК_ЗатратыДругиеЗатраты);
	Запрос.УстановитьПараметр("СтатьяЗатраты",                        Справочники.СтатьиНалоговыхДеклараций.ЕННК_Затраты);
	Запрос.УстановитьПараметр("СтатьяЗатратыПроизводствоСХПродукции", Справочники.СтатьиНалоговыхДеклараций.ЕННК_ЗатратыПроизводствоСХПродукции);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КурсыВалют.Период КАК Период,
	|	КурсыВалют.Валюта КАК Валюта,
	|	КурсыВалют.Курс КАК Курс,
	|	КурсыВалют.Кратность КАК Кратность
	|ПОМЕСТИТЬ ТаблицаКурсовВалют
	|ИЗ
	|	РегистрСведений.КурсыВалют КАК КурсыВалют
	|ГДЕ
	|	КурсыВалют.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КурсыВалютСрезПоследних.Период,
	|	КурсыВалютСрезПоследних.Валюта,
	|	КурсыВалютСрезПоследних.Курс,
	|	КурсыВалютСрезПоследних.Кратность
	|ИЗ
	|	РегистрСведений.КурсыВалют.СрезПоследних(ДОБАВИТЬКДАТЕ(&НачалоПериода, ДЕНЬ, -1), ) КАК КурсыВалютСрезПоследних
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаКурсовВалют.Валюта КАК Валюта,
	|	ТаблицаКурсовВалют.Курс КАК Курс,
	|	ТаблицаКурсовВалют.Кратность КАК Кратность,
	|	ГраницыПериода.ПериодНачало КАК ПериодНачало,
	|	ЕСТЬNULL(ГраницыПериода.ПериодКонец, &КонецПериода) КАК ПериодКонец
	|ПОМЕСТИТЬ ТаблицаКурсовВалютПериоды
	|ИЗ
	|	ТаблицаКурсовВалют КАК ТаблицаКурсовВалют
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ТаблицаКурсыВалют.Валюта КАК Валюта,
	|			ТаблицаКурсыВалют.Период КАК ПериодНачало,
	|			МИНИМУМ(ТаблицаКурсыВалютКопия.Период) КАК ПериодКонец
	|		ИЗ
	|			ТаблицаКурсовВалют КАК ТаблицаКурсыВалют
	|				ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсовВалют КАК ТаблицаКурсыВалютКопия
	|				ПО ТаблицаКурсыВалют.Валюта = ТаблицаКурсыВалютКопия.Валюта
	|					И ТаблицаКурсыВалют.Период < ТаблицаКурсыВалютКопия.Период
	|		
	|		СГРУППИРОВАТЬ ПО
	|			ТаблицаКурсыВалют.Валюта,
	|			ТаблицаКурсыВалют.Период) КАК ГраницыПериода
	|		ПО ТаблицаКурсовВалют.Валюта = ГраницыПериода.Валюта
	|			И ТаблицаКурсовВалют.Период = ГраницыПериода.ПериодНачало
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(КнигаДоходовРасходов.Период, ДЕНЬ) КАК Период,
	|	КнигаДоходовРасходов.Регистратор КАК Регистратор,
	|	КнигаДоходовРасходов.Статья КАК Статья,
	|	КнигаДоходовРасходов.Валюта КАК Валюта,
	|	ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяЗатратыСвязанныеСПриобретением
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Статья3,
	|	ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяОплатаТруда
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Статья4,
	|	ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяЕСВ
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Статья5,
	|	ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяЗатратыПроизводствоСХПродукции
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Статья6,
	|	ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяДругиеЗатраты
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Статья7,
	|	ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяЗатратыСвязанныеСПриобретением
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ + ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяОплатаТруда
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ + ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяЕСВ
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0
	|	КОНЕЦ + ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяДругиеЗатраты
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0 
	|	КОНЕЦ + ВЫБОР
	|		КОГДА КнигаДоходовРасходов.Статья = &СтатьяЗатратыПроизводствоСХПродукции
	|			ТОГДА КнигаДоходовРасходов.СуммаОборот * ТаблицаКурсовВалютПериоды.Курс / ТаблицаКурсовВалютПериоды.Кратность
	|		ИНАЧЕ 0 
	|	КОНЕЦ КАК Статья8
	|ИЗ
	|	РегистрНакопления.КнигаДоходовРасходовПоЕдиномуНалогу.Обороты(
	|			&НачалоПериода,
	|			&КонецПериода,
	|			Регистратор,
	|			Организация = &Организация
	|				И Статья В ИЕРАРХИИ (&СтатьяЗатраты)) КАК КнигаДоходовРасходов
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсовВалютПериоды КАК ТаблицаКурсовВалютПериоды
	|		ПО КнигаДоходовРасходов.Валюта = ТаблицаКурсовВалютПериоды.Валюта
	|			И КнигаДоходовРасходов.Период >= ТаблицаКурсовВалютПериоды.ПериодНачало
	|			И КнигаДоходовРасходов.Период < ТаблицаКурсовВалютПериоды.ПериодКонец
	|
	|УПОРЯДОЧИТЬ ПО
	|	КнигаДоходовРасходов.Период,
	|	КнигаДоходовРасходов.Регистратор
	|ИТОГИ
	|	СУММА(Статья3),
	|	СУММА(Статья4),
	|	СУММА(Статья5),
	|	СУММА(Статья6),
	|	СУММА(Статья7),
	|	СУММА(Статья8)
	|ПО
	|	ОБЩИЕ,
	|	Период";
	
	ОбластьСтрока    = Макет.ПолучитьОбласть("Строка");
	ОбластьДень      = Макет.ПолучитьОбласть("День");
	ОбластьИтог     = Макет.ПолучитьОбласть("Итог");
	
	РезультатЗапроса = Запрос.Выполнить(); 
	ВыборкаДень = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Период");
	
	ТабДокумент.НачатьГруппуСтрок("Итог");
	
	Пока ВыборкаДень.Следующий() Цикл
		
		ТабДокумент.НачатьГруппуСтрок("День");
		Выборка = ВыборкаДень.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Если Выборка.ТипЗаписи() <> ТипЗаписиЗапроса.ДетальнаяЗапись Тогда
				Продолжить;
			КонецЕсли;
			
			ОбластьСтрока.Параметры.Заполнить(Выборка);
			ОбластьСтрока.Параметры.ДатаНомер = Формат(ВыборкаДень.Период, "ДФ=dd.MM.yyyy");
			ТабДокумент.Вывести(ОбластьСтрока);
			
		КонецЦикла;
		
		ТабДокумент.ЗакончитьГруппуСтрок();
		
		ОбластьДень.Параметры.Заполнить(ВыборкаДень);
		День = ВыборкаДень.Период;
		ОбластьДень.Параметры.Итого = "Разом за " + Формат(День, "ДЛФ=D") + ":";
		ТабДокумент.Вывести(ОбластьДень);
		
	КонецЦикла;
		
	ТабДокумент.ЗакончитьГруппуСтрок();

	ВыборкаОбщиеИтоги = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам,"Общие");
	ВыборкаОбщиеИтоги.Следующий();
	ОбластьИтог.Параметры.Заполнить(ВыборкаОбщиеИтоги);
	ОбластьИтог.Параметры.Итого = "Разом:";
	ТабДокумент.Вывести(ОбластьИтог); 
	
	ОбластьПодвал   = Макет.ПолучитьОбласть("Подвал");
	ТабДокумент.Вывести(ОбластьПодвал);
	
	ТабДокумент.ИмяПараметровПечати = "КнигаДоходовРасходовПоЕдиномуНалогу";
	
КонецПроцедуры
