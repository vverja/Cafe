#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Возвращает настройку контроля обеспечения склада
//
//	Параметры:
//		Склад - СправочникСсылка.Склады - склад, для которого необходимо получить настройку контроля обеспечения
//	Возвращаемое значение:
//		Булево - настройка контроля обеспечения склада. Неопределено, если настройка отсутствует.
//
Функция НастройкаСклада(Склад) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Настройка.Контролировать КАК Контролировать
	|ИЗ
	|	РегистрСведений.НастройкаКонтроляОбеспечения КАК Настройка
	|ГДЕ
	|	Настройка.Склад = &Склад
	|	И Настройка.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	И Настройка.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)");

	Запрос.УстановитьПараметр("Склад", Склад);

	Выборка = Запрос.Выполнить().Выбрать();
	Результат = Неопределено;
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Контролировать;
	КонецЕсли;

	Возврат Результат;

КонецФункции

// Сохраняет настройку контроля обеспечения склада
//
//	Параметры:
//		Склад - СправочникСсылка.Склады - склад, для которого необходимо сохранить настройку контроля обеспечения
//		Контролировать - Булево - необходимость контроля обеспечения по складу, сохраняемое значение.
//
Процедура УстановитьНастройку(Склад, Контролировать) Экспорт

	НастройкаКонтроляОбеспечения = НастройкаСклада(Склад);

	Если НастройкаКонтроляОбеспечения <> Контролировать Тогда

		МенеджерЗаписи = РегистрыСведений.НастройкаКонтроляОбеспечения.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Склад = Склад;
		МенеджерЗаписи.Контролировать = Контролировать;

		МенеджерЗаписи.Записать();

	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытий

#Область ОбновлениеИнформационнойБазы

// Обработчик обновления УТ 11.1.4.0
// Обрабатывает незакрытые в "Графике движения товаров" распоряжения из регистра "Движения товаров",
// имеющие строки с незаполненным "Вариантом обеспечения" и заполненным вариантом контроля остатков.
//
// Заполняет вариант обеспечения.
// "Со склада", при варианте контроля остатков "Остатки с учетом резерва".
// "Из заказов", при варианте контроля остатков "Остатки с учетом графика", если дата отгрузки дограницы контроля.
//
// Корректирует движения по измененным строкам документов.
//
// 1) Заказ с вариантом обеспечения "Со склада" либо "Из заказов":
// cтарые движения:
//    "Движение товаров": + ПланируемаяОтгрузкаНеобеспеченная().
// новые движения:
//    "Движение товаров": + ПланируемаяОтгрузкаСоСклада() либо + ПланируемаяОтгрузка(),
//    "Свободные остатки": приход ВРезервеСоСклада().
//
// 2) Расходная накладная по строке заказа с вариантом обеспечения "Со склада" либо "Из заказов":
// cтарые движения:
//    "Движение товаров": - ПланируемаяОтгрузкаНеобеспеченная().
// новые движения:
//    "Движение товаров": - ПланируемаяОтгрузкаСоСклада() либо - ПланируемаяОтгрузка().
//    "Свободные остатки":  расход ВРезервеСоСклада().
//
// Заполняет новый ресурс Контролировать() для вариантов "Остатки с учетом резерва",
// "Остатки c учетом графика", "Остатки".
//
//Очищает ресурс "Вариант контроля остатков".
Процедура ОчиститьВариантКонтроляЗаполнитьВариантОбеспеченияМонопольно() Экспорт
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#КонецЕсли